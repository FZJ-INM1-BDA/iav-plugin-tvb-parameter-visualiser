var app=function(){"use strict";function e(){}function t(e){return e()}function n(){return Object.create(null)}function l(e){e.forEach(t)}function a(e){return"function"==typeof e}function r(e,t){return e!=e?t==t:e!==t||e&&"object"==typeof e||"function"==typeof e}function s(e,t){e.appendChild(t)}function i(e,t,n){e.insertBefore(t,n||null)}function c(e){e.parentNode.removeChild(e)}function o(e,t){for(let n=0;n<e.length;n+=1)e[n]&&e[n].d(t)}function d(e){return document.createElement(e)}function u(e){return document.createTextNode(e)}function f(){return u(" ")}function m(){return u("")}function p(e,t,n,l){return e.addEventListener(t,n,l),()=>e.removeEventListener(t,n,l)}function g(e,t,n){null==n?e.removeAttribute(t):e.getAttribute(t)!==n&&e.setAttribute(t,n)}function h(e,t){t=""+t,e.data!==t&&(e.data=t)}let _;function v(e){_=e}function $(){if(!_)throw new Error("Function called outside component initialization");return _}function b(e){$().$$.on_mount.push(e)}function y(){const e=$();return(t,n)=>{const l=e.$$.callbacks[t];if(l){const a=function(e,t){const n=document.createEvent("CustomEvent");return n.initCustomEvent(e,!1,!1,t),n}(t,n);l.slice().forEach(t=>{t.call(e,a)})}}}const x=[],w=[],k=[],L=[],N=Promise.resolve();let E=!1;function A(e){k.push(e)}let F=!1;const I=new Set;function D(){if(!F){F=!0;do{for(let e=0;e<x.length;e+=1){const t=x[e];v(t),V(t.$$)}for(x.length=0;w.length;)w.pop()();for(let e=0;e<k.length;e+=1){const t=k[e];I.has(t)||(I.add(t),t())}k.length=0}while(x.length);for(;L.length;)L.pop()();E=!1,F=!1,I.clear()}}function V(e){if(null!==e.fragment){e.update(),l(e.before_update);const t=e.dirty;e.dirty=[-1],e.fragment&&e.fragment.p(e.ctx,t),e.after_update.forEach(A)}}const C=new Set;function T(e,t){e&&e.i&&(C.delete(e),e.i(t))}function P(e,t,n,l){if(e&&e.o){if(C.has(e))return;C.add(e),(void 0).c.push(()=>{C.delete(e),l&&(n&&e.d(1),l())}),e.o(t)}}function H(e){e&&e.c()}function S(e,n,r){const{fragment:s,on_mount:i,on_destroy:c,after_update:o}=e.$$;s&&s.m(n,r),A(()=>{const n=i.map(t).filter(a);c?c.push(...n):l(n),e.$$.on_mount=[]}),o.forEach(A)}function M(e,t){const n=e.$$;null!==n.fragment&&(l(n.on_destroy),n.fragment&&n.fragment.d(t),n.on_destroy=n.fragment=null,n.ctx=[])}function j(e,t){-1===e.$$.dirty[0]&&(x.push(e),E||(E=!0,N.then(D)),e.$$.dirty.fill(0)),e.$$.dirty[t/31|0]|=1<<t%31}function O(t,a,r,s,i,o,d=[-1]){const u=_;v(t);const f=a.props||{},m=t.$$={fragment:null,ctx:null,props:o,update:e,not_equal:i,bound:n(),on_mount:[],on_destroy:[],before_update:[],after_update:[],context:new Map(u?u.$$.context:[]),callbacks:n(),dirty:d};let p=!1;if(m.ctx=r?r(t,f,(e,n,...l)=>{const a=l.length?l[0]:n;return m.ctx&&i(m.ctx[e],m.ctx[e]=a)&&(m.bound[e]&&m.bound[e](a),p&&j(t,e)),n}):[],m.update(),p=!0,l(m.before_update),m.fragment=!!s&&s(m.ctx),a.target){if(a.hydrate){const e=function(e){return Array.from(e.childNodes)}(a.target);m.fragment&&m.fragment.l(e),e.forEach(c)}else m.fragment&&m.fragment.c();a.intro&&T(t.$$.fragment),S(t,a.target,a.anchor),D()}v(u)}class U{$destroy(){M(this,1),this.$destroy=e}$on(e,t){const n=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return n.push(t),()=>{const e=n.indexOf(t);-1!==e&&n.splice(e,1)}}$set(){}}function z(e,t,n){const l=e.slice();return l[5]=t[n],l}function G(e){let t,n=e[2]&&K(e);return{c(){n&&n.c(),t=m()},m(e,l){n&&n.m(e,l),i(e,t,l)},p(e,l){e[2]?n?n.p(e,l):(n=K(e),n.c(),n.m(t.parentNode,t)):n&&(n.d(1),n=null)},d(e){n&&n.d(e),e&&c(t)}}}function B(e){let t,n=e[0],l=[];for(let t=0;t<n.length;t+=1)l[t]=R(z(e,n,t));return{c(){for(let e=0;e<l.length;e+=1)l[e].c();t=m()},m(e,n){for(let t=0;t<l.length;t+=1)l[t].m(e,n);i(e,t,n)},p(e,a){if(1&a){let r;for(n=e[0],r=0;r<n.length;r+=1){const s=z(e,n,r);l[r]?l[r].p(s,a):(l[r]=R(s),l[r].c(),l[r].m(t.parentNode,t))}for(;r<l.length;r+=1)l[r].d(1);l.length=n.length}},d(e){o(l,e),e&&c(t)}}}function K(e){let t,n;return{c(){t=d("option"),n=u(e[2]),t.__value=e[2],t.value=t.__value},m(e,l){i(e,t,l),s(t,n)},p(e,l){4&l&&h(n,e[2]),4&l&&(t.__value=e[2]),t.value=t.__value},d(e){e&&c(t)}}}function R(e){let t,n,l,a,r=e[5]+"";return{c(){t=d("option"),n=u(r),l=f(),t.__value=a=e[5],t.value=t.__value},m(e,a){i(e,t,a),s(t,n),s(t,l)},p(e,l){1&l&&r!==(r=e[5]+"")&&h(n,r),1&l&&a!==(a=e[5])&&(t.__value=a),t.value=t.__value},d(e){e&&c(t)}}}function W(t){let n,l,a,r,o;function u(e,t){return(null==a||1&t)&&(a=!!(e[0]&&Array.isArray(e[0])&&e[0].length>0)),a?B:G}let f=u(t,-1),m=f(t);return{c(){n=d("select"),l=d("option"),l.textContent="-- select --\n  ",m.c(),l.__value="null",l.value=l.__value,l.disabled=!0,n.disabled=t[1]},m(e,a,c){i(e,n,a),s(n,l),m.m(n,null),r=t[2]||"null";for(var d=0;d<n.options.length;d+=1){var u=n.options[d];if(u.__value===r){u.selected=!0;break}}c&&o(),o=p(n,"change",t[3])},p(e,[t]){if(f===(f=u(e,t))&&m?m.p(e,t):(m.d(1),m=f(e),m&&(m.c(),m.m(n,null))),4&t&&r!==(r=e[2]||"null"))for(var l=0;l<n.options.length;l+=1){var a=n.options[l];if(a.__value===r){a.selected=!0;break}}2&t&&(n.disabled=e[1])},i:e,o:e,d(e){e&&c(n),m.d(),o()}}}function q(e,t,n){let{inputList:l}=t,{disabled:a}=t,{selectedVal:r}=t;const s=y();return e.$set=e=>{"inputList"in e&&n(0,l=e.inputList),"disabled"in e&&n(1,a=e.disabled),"selectedVal"in e&&n(2,r=e.selectedVal)},[l,a,r,function(e){const t=e.srcElement.value;s("selectChanged",{value:t})}]}class J extends U{constructor(e){super(),O(this,e,q,W,r,{inputList:0,disabled:1,selectedVal:2})}}function Q(e){return d3.extent(e.map(e=>d3.extent(e)).reduce((e,t)=>e.concat(t),[]))}function X(t){let n;return{c(){n=d("div"),n.textContent="No datas to display"},m(e,t){i(e,n,t)},p:e,d(e){e&&c(n)}}}function Y(t){let n;return{c(){n=d("div"),g(n,"class","graph-container svelte-rklmzr")},m(e,l){i(e,n,l),t[5](n)},p:e,d(e){e&&c(n),t[5](null)}}}function Z(t){let n;function l(e,t){return e[0]&&e[0].length>0?Y:X}let a=l(t),r=a(t);return{c(){r.c(),n=m()},m(e,t){r.m(e,t),i(e,n,t)},p(e,[t]){a===(a=l(e))&&r?r.p(e,t):(r.d(1),r=a(e),r&&(r.c(),r.m(n.parentNode,n)))},i:e,o:e,d(e){r.d(e),e&&c(n)}}}function ee(e,t,n){let l,a,{datas:r}=t;const s={left:40,top:0,right:10,bottom:20};let{yDomain:i}=t;var c;return c=()=>{if(r&&l){for(;l.children[0];)l.removeChild(l.children[0]);const{left:t,right:n,top:a,bottom:c}=s,o=l.clientWidth-t-n,d=l.clientHeight-a-c,u=d3.scaleLinear().range([0,o]),f=d3.scaleLinear().range([d,0]),m=d3.select(l).append("svg").attr("width","100%").attr("height","100%").append("g").attr("transform",`translate(${t}, ${a})`),p=d3.max(r.map(e=>e.length));u.domain([0,p]),f.domain(i||Q(r));for(const t in r){const n=d3.line().x(e=>u(e.x)).y(e=>f(e.y));m.append("path").attr("fill","none").attr("stroke-width","1px").attr("stroke",(e=t,`hsl(${97*e}, 100%, 50%)`)).data([r[t].map((e,t)=>({x:t,y:e}))]).attr("d",n)}m.append("g").attr("transform",`translate(0, ${d})`).call(d3.axisBottom(u)),m.append("g").call(d3.axisLeft(f))}var e},$().$$.before_update.push(c),b(()=>(console.log("mounting graph.svelte"),a=interactiveViewer.pluginControl.loadExternalLibraries(["d3@5.7.0"]),()=>{console.log("unmounting graph.svelte"),interactiveViewer.pluginControl.unloadExternalLibraries(["d3@5.7.0"])})),e.$set=e=>{"datas"in e&&n(0,r=e.datas),"yDomain"in e&&n(2,i=e.yDomain)},[r,l,i,a,s,function(e){w[e?"unshift":"push"](()=>{n(1,l=e)})}]}class te extends U{constructor(e){var t;super(),document.getElementById("svelte-rklmzr-style")||((t=d("style")).id="svelte-rklmzr-style",t.textContent=".graph-container.svelte-rklmzr{height:20rem}",s(document.head,t)),O(this,e,ee,Z,r,{datas:0,yDomain:2})}}function ne(e,t,n){const l=e.slice();return l[22]=t[n],l}function le(e){let t,n,l,a,r,o,m,_=e[22]+"";function v(...t){return e[20](e[22],...t)}return{c(){t=d("div"),n=d("span"),l=u(_),a=f(),r=d("button"),r.textContent="Ã—",o=f(),g(r,"class","close"),g(t,"class","d-inline-block d-flex align-items-center")},m(e,c,d){i(e,t,c),s(t,n),s(n,l),s(t,a),s(t,r),s(t,o),d&&m(),m=p(r,"click",v)},p(t,n){e=t,128&n&&_!==(_=e[22]+"")&&h(l,_)},d(e){e&&c(t),m()}}}function ae(e){let t,n,l,a,r,o,m,_=e[4][e[5]]?"Pin (alt/option + w)":"Hover or select area";return{c(){t=d("div"),n=d("i"),l=f(),a=d("span"),r=u(_),g(n,"class","fas fa-thumbtack"),g(t,"class",o="mt-2 btn btn-dark "+(e[4][e[5]]?"":"tvb-plugin-muted")+" svelte-1mng8sy")},m(c,o,d){i(c,t,o),s(t,n),s(t,l),s(t,a),s(a,r),d&&m(),m=p(t,"click",e[11])},p(e,n){48&n&&_!==(_=e[4][e[5]]?"Pin (alt/option + w)":"Hover or select area")&&h(r,_),48&n&&o!==(o="mt-2 btn btn-dark "+(e[4][e[5]]?"":"tvb-plugin-muted")+" svelte-1mng8sy")&&g(t,"class",o)},d(e){e&&c(t),m()}}}function re(e){let t,n,l,a,r,u,m,h,_,v,$,b,y,x,w,k,L,N,E,A,F;const I=new J({props:{inputList:e[0],disabled:e[6],selectedVal:e[1]}});I.$on("selectChanged",e[8]);const D=new J({props:{inputList:e[2],disabled:e[6]||!e[1],selectedVal:e[3]}});D.$on("selectChanged",e[9]);const V=new J({props:{inputList:e[4].map(se),disabled:e[6]||!e[3],selectedVal:e[5]}});V.$on("selectChanged",e[10]);let C=e[7],j=[];for(let t=0;t<C.length;t+=1)j[t]=le(ne(e,C,t));let O=!e[6]&&ae(e);const U=new te({props:{datas:[...e[7],e[5]].map(e[21]).filter(ie),yDomain:Q(e[4])}});return{c(){t=d("div"),n=d("div"),l=d("label"),l.textContent="Select dataset",a=f(),H(I.$$.fragment),r=f(),u=d("div"),m=d("label"),m.textContent="Select file",h=f(),H(D.$$.fragment),v=f(),$=d("div"),b=d("label"),b.textContent="Select index",y=f(),H(V.$$.fragment),w=f(),k=d("div");for(let e=0;e<j.length;e+=1)j[e].c();L=f(),O&&O.c(),N=f(),E=d("div"),H(U.$$.fragment),g(l,"class","d-inline-block"),g(n,"class","d-flex flex-column"),g(m,"class","d-inline-block"),g(u,"class",_="d-flex flex-column pt-2 "+(e[1]?"":"tvb-plugin-muted")+" svelte-1mng8sy"),g(b,"class","d-inline-block"),g($,"class",x="d-flex flex-column pt-2 "+(e[1]&&e[3]?"":"tvb-plugin-muted")+" svelte-1mng8sy"),g(k,"class","d-flex pt-2 flex-row flex-wrap"),g(E,"class","d-flex flex-column pt-2"),g(t,"class","d-flex flex-column m-2")},m(c,o,d){i(c,t,o),s(t,n),s(n,l),s(n,a),S(I,n,null),s(t,r),s(t,u),s(u,m),s(u,h),S(D,u,null),s(t,v),s(t,$),s($,b),s($,y),S(V,$,null),s(t,w),s(t,k);for(let e=0;e<j.length;e+=1)j[e].m(k,null);s(t,L),O&&O.m(t,null),s(t,N),s(t,E),S(U,E,null),A=!0,d&&F(),F=p(window,"keydown",e[19])},p(e,[n]){const l={};1&n&&(l.inputList=e[0]),64&n&&(l.disabled=e[6]),2&n&&(l.selectedVal=e[1]),I.$set(l);const a={};4&n&&(a.inputList=e[2]),66&n&&(a.disabled=e[6]||!e[1]),8&n&&(a.selectedVal=e[3]),D.$set(a),(!A||2&n&&_!==(_="d-flex flex-column pt-2 "+(e[1]?"":"tvb-plugin-muted")+" svelte-1mng8sy"))&&g(u,"class",_);const r={};if(16&n&&(r.inputList=e[4].map(se)),72&n&&(r.disabled=e[6]||!e[3]),32&n&&(r.selectedVal=e[5]),V.$set(r),(!A||10&n&&x!==(x="d-flex flex-column pt-2 "+(e[1]&&e[3]?"":"tvb-plugin-muted")+" svelte-1mng8sy"))&&g($,"class",x),4224&n){let t;for(C=e[7],t=0;t<C.length;t+=1){const l=ne(e,C,t);j[t]?j[t].p(l,n):(j[t]=le(l),j[t].c(),j[t].m(k,null))}for(;t<j.length;t+=1)j[t].d(1);j.length=C.length}e[6]?O&&(O.d(1),O=null):O?O.p(e,n):(O=ae(e),O.c(),O.m(t,N));const s={};176&n&&(s.datas=[...e[7],e[5]].map(e[21]).filter(ie)),16&n&&(s.yDomain=Q(e[4])),U.$set(s)},i(e){A||(T(I.$$.fragment,e),T(D.$$.fragment,e),T(V.$$.fragment,e),T(U.$$.fragment,e),A=!0)},o(e){P(I.$$.fragment,e),P(D.$$.fragment,e),P(V.$$.fragment,e),P(U.$$.fragment,e),A=!1},d(e){e&&c(t),M(I),M(D),M(V),o(j,e),O&&O.d(),M(U),F()}}}const se=(e,t)=>t,ie=e=>!!e;function ce(e,t,n){let{datasetArray:l=[]}=t,{selectedDataset:a=null}=t,{fetchedFiles:r=[]}=t,{selectedFile:s=null}=t,{fetchedDataFromFile:i=[]}=t,{staticFlag:c}=t,{selectedTrackIndex:o}=t,{selectedTrackIndices:d=[]}=t;const u=new Set;let f=[];const m=()=>{n(0,l=[]),n(1,a=null),fetch(`${__HOSTNAME__}/data/`).then(e=>e.json()).then(e=>{n(0,l=e)})};function p(){n(2,r=[]),n(3,s=null);const e=new URL(`${__HOSTNAME__}/data/get_filtered_filenames`);e.searchParams.set("kgDatasetId",a),fetch(e).then(e=>e.json()).then(e=>{n(2,r=e.map(({name:e})=>e))})}function g(e){n(5,o=e),n(13,d=[e])}function h(){u.add(o),n(7,f=Array.from(u))}function _(e){u.delete(e),n(7,f=Array.from(u))}b(()=>{const e=[];if(c){if(s&&a){const e=new URL(`${__HOSTNAME__}/data/get_matrix`);e.searchParams.set("filename",s),e.searchParams.set("kgDatasetId",a),fetch(e).then(e=>e.json()).then(e=>{n(4,i=e)})}}else{m(),interactiveViewer.viewerHandle.setLayerVisibility({name:/jubrain/},!1);const t={};t[`${__PLUGIN_NAME__}-DK68`]={type:"segmentation",source:`nifti://${__HOSTNAME__}/data/public/aparcaseg.nii.gz`,selectedOpacity:.5},interactiveViewer.viewerHandle.loadLayer(t),e.push(interactiveViewer.viewerHandle.mouseOverNehubaLayers.subscribe(e=>{if(n(5,o=null),e){const t=e.find(({layer:e})=>e.name===`${__PLUGIN_NAME__}-DK68`);if(t){const e=/#([0-9]{1,})$/.exec(t.segment);e&&g(Number(e[1]))}}}))}return()=>{for(c||(interactiveViewer.viewerHandle.setLayerVisibility({name:/jubrain/},!0),interactiveViewer.viewerHandle.removeLayer({name:`${__PLUGIN_NAME__}-DK68`}));e.length>0;)e.pop().unsubscribe()}});return e.$set=e=>{"datasetArray"in e&&n(0,l=e.datasetArray),"selectedDataset"in e&&n(1,a=e.selectedDataset),"fetchedFiles"in e&&n(2,r=e.fetchedFiles),"selectedFile"in e&&n(3,s=e.selectedFile),"fetchedDataFromFile"in e&&n(4,i=e.fetchedDataFromFile),"staticFlag"in e&&n(6,c=e.staticFlag),"selectedTrackIndex"in e&&n(5,o=e.selectedTrackIndex),"selectedTrackIndices"in e&&n(13,d=e.selectedTrackIndices)},[l,a,r,s,i,o,c,f,function(e){n(1,a=e.detail.value),p()},function(e){n(4,i=[]),n(3,s=e.detail.value);const t=new URL(`${__HOSTNAME__}/data/get_matrix`);t.searchParams.set("filename",s),t.searchParams.set("kgDatasetId",a),fetch(t).then(e=>e.json()).then(e=>{n(4,i=e)})},function(e){const t=e.detail.value;g(Number(t))},h,_,d,u,m,p,g,function(){const e=new URL(`${__HOSTNAME__}/frontend/manifest.json`);e.searchParams.set("selectedDataset",a),e.searchParams.set("selectedFile",s),e.searchParams.set("selectedTrackIndices",d.join(",")),fetch(e).then(e=>e.json()).then(e=>{interactiveViewer.uiHandle.launchNewWidget(e)})},e=>!c&&"KeyW"===e.code&&e.altKey&&h(),e=>_(e),e=>i[e]]}class oe extends U{constructor(e){var t;super(),document.getElementById("svelte-1mng8sy-style")||((t=d("style")).id="svelte-1mng8sy-style",t.textContent=".tvb-plugin-muted.svelte-1mng8sy{opacity:0.5}",s(document.head,t)),O(this,e,ce,re,r,{datasetArray:0,selectedDataset:1,fetchedFiles:2,selectedFile:3,fetchedDataFromFile:4,staticFlag:6,selectedTrackIndex:5,selectedTrackIndices:13})}}const de=document.getElementById(`${__PLUGIN_NAME__}.container`),ue=de.getAttribute("static-flag"),fe=de.getAttribute("selected-file"),me=de.getAttribute("selected-dataset"),pe=de.getAttribute("selected-track-index"),ge=de.getAttribute("selected-track-indices");let he;return interactiveViewer.pluginControl.loadExternalLibraries(["d3@5.7.0"]).then(()=>{he=new oe({target:de,props:{staticFlag:ue,selectedFile:fe,selectedDataset:me,selectedTrackIndex:pe,selectedTrackIndices:ge&&ge.split(",").map(e=>Number(e)).filter(e=>NaN!==e)}}),interactiveViewer.pluginControl[__PLUGIN_NAME__].onShutdown(()=>{console.log(`onShutdown ${__PLUGIN_NAME__}`),he.$destroy()})}),he}();
//# sourceMappingURL=script.js.map
